; -------- Test: `ExhaustiveDeps` --------
(rule
 (targets ExhaustiveDepsUseEffect.actual)
 (deps
  (:pp ../bin/Bin.exe)
  (:input ExhaustiveDepsUseEffect.ml)
 )
 (action
  ; expect the process to fail, capturing stderr
  (with-stderr-to
   %{targets}
   (bash "! ./%{pp} %{input}")
  )
 )
)

(rule
 (targets ExhaustiveDepsUseEffect.ml)
 (deps ExhaustiveDepsUseEffect.re)
 (action
  (with-stdout-to
   %{targets}
   (run refmt --parse=re --print=ml %{deps})
  )
 )
)

; -------- Test: `ConditionalHooks` --------
(rule
 (targets ConditionalHooks.actual)
 (deps
  (:pp ../bin/Bin.exe)
  (:input ConditionalHooks.ml)
 )
 (action
  (progn
   ; expect the process to fail, capturing stderr
   (with-stderr-to
    %{targets}
    (bash "! ./%{pp} %{input}")
   )
  )
 )
)

(rule
 (targets ConditionalHooks.ml)
 (deps ConditionalHooks.re)
 (action
  (progn
   (with-stdout-to
    %{targets}
    (run refmt --parse=re --print=ml %{deps})
   )
  )
 )
)

; Compare the post-processed output to the .expected file
(rule
 (alias runtest)
 (action
  (progn
   (diff ExhaustiveDepsUseEffect.expected ExhaustiveDepsUseEffect.actual)
   (diff ConditionalHooks.expected ConditionalHooks.actual)
  )
 )
)
